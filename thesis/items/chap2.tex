% !TEX root = ../thesis-main.tex
\section{Разработка инструмента генерации программ}
Сравнительный анализ существующих решений для генерации программ показал, что
инструменты, используемые на практике, не подходят для учебных целей. Эти инструменты
в основном заточены под конкретный язык программирования, у многих слабая кастомизация
и нет удобного способа описания шаблона программы. Поэтому было принято решение
разработать собственную систему генерации программ для учебных задач.

\subsection{Требования к системе генерации}
Разрабатываемый инструмент должен обладать следующими возможностями:
\begin{itemize}
    \item Возможность генерации базовых элементов языка программирования;
    \item Поддержка генерации кода на разных языках, чтобы иметь возможность использовать данный
          инструмент в разных обучающих курсах;
    \item Расширяемость, что включает в себя:
          \begin{itemize}
              \item Гибкую систему создания шаблонов для генерации задач;
              \item Возможность настройки параметров генерации;
              \item Высокую вариативность задач, поддержку рандомизации отдельных элементов кода
          \end{itemize}
\end{itemize}

\subsection{Схема генерации программ}
На схеме \ref{generation-steps} предоставлена схема генерации кода программы.
\begin{figure}[ht]
    \begin{center}
        \scalebox{0.8}{
            \includesvg[inkscapelatex=false]{images/generation-steps.svg}
        }
        \caption{\label{generation-steps} Схема генерации кода программы}
    \end{center}
\end{figure}
\clearpage

Разберём ее подробнее. На первом шаге выбирается шаблон, из которого будет генерироваться
программа. Подробнее о шаблонах можно прочитать в разделе \ref{templates}.
\texttt{seed} представляет собой целое
64-битное число, словарь атрибутов сопоставляет строковому ключу список строковых значений,
некоторые из которых могут быть преобразованы в числа.
На последнем этапе происходит преобразование промежуточного представления в код. Во время преобразования
элементам промежуточного предоставление сопоставляются элементы синтаксиса конкретного языка программирования.


\subsection{Промежуточное представление}
При генерации кода на разных языках можно выделить конструкции, которые имеют схожую
семантику в разных языках, но, при этом, могут отличаться синтаксически. Такими
конструкциями являются к примеру:

\begin{itemize}
    \item Арифметические выражения
    \item Условные ветвления (\texttt{if...else})
    \item Множественный выбор/сопоставление с образцом (\texttt{switch...case, match, when, case...of})
    \item Циклы (\texttt{for, while})
    \item Объявление и инициализация переменных
    \item Объявление, определение и вызов функций
    \item Блоки кода
    \item Инструкции подключения модулей/библиотек (\texttt{import, include})
    \item Строковые и числовые литералы
    \item Объявление классов и структур
    \item \dots
\end{itemize}
\label{syntax-items}

Из данных сущностей можно составить структуру данных, которой можно сопоставить код
на разных языках программирования. Такая структура и будет промежуточным представлением.
Опишем ее подробнее.

Промежуточное представление является по сути расширением абстрактного синтаксического
дерева (AST)

<<Дерево абстрактного синтаксиса (ДАС) — в информатике конечное помеченное ориентированное дерево, в котором внутренние вершины сопоставлены (помечены) с операторами языка программирования, а листья — с соответствующими операндами. Таким образом, листья являются пустыми операторами и представляют только переменные и константы.>> \cite{ast}

В отличие от чистого AST промежуточное представление, используемое в проекте, хранит
некоторую информацию о синтаксисе языка (или группы языков), в которые оно в дальнейшем
будет интерпретировано. К примеру, в данном дереве могут содержаться скобки в арифметических выражениях,
также промежуточное представление хранит метку (тег), соответствующую группе языков.

\subsection{Шаблоны программ}
\label{templates}

Заметим, что промежуточное представление соответствует конкретной программе на
выбранном языке программирования. Однако, для обучающих целей предпочтительнее
иметь возможность зафиксировать общую логику программы, но иметь возможность
настраивать какие-то параметры для генерации индивидуального варианта программы
под каждого студента (аналог вариантов для письменных проверочных работ).

Для этих целей необходимо создать структуру данных (<<шаблон>>), которая бы поддерживала
параметризацию и при подстановке параметров преобразовывалась в промежуточное
представление (\ref{generation-steps}).
Структура шаблона похожа на внутреннее представление, за исключением того, что
помимо вершин, соответствующих элементам синтаксиса, в нем также могут присутствовать
специальные вершины, обозначающие случайное значение, какое-либо преобразование
поддерева или значение какого-либо атрибута.

\subsection{Архитектура системы}
Для поддержки одновременной работы с несколькими пользователями и возможности
добавления шаблонов и валидации ответов студентов разработанная система имеет
клиент-серверную архитектуру с отдельными микросервисами для
некоторых компонент. Благодаря этому удалось добиться конфиденциальности правильных
ответов и контроля над управлением шаблонов.

Клиентская часть представляет собой веб-сайт с помощью которого пользователь может делать
запросы на получение текста или картинки кода по шаблону (задаче). Также имеется возможность
делать запросы напрямую к API в формате JSON \cite{json}.

Серверная часть состоит из нескольких компонент: непосредственно веб-сервер, система генерации
кода и система проверки ответов студентов. В отдельный микросервис выделена система хранения
текстов и изображений программ, состоящая из базы данных, находящейся в изолированном окружении.

Схема архитектуры показана на изображении \ref{architecture}, ниже подробнее описаны отдельные
компоненты.

\begin{figure}[ht]
    \begin{center}
        \scalebox{0.6}{
            \includegraphics{images/architecture.png}
            % \includesvg[inkscapelatex=false]{images/architecture.drawio.svg}
        }
        \caption{\label{architecture} Архитектура системы генерации программ}
    \end{center}
\end{figure}
\clearpage

\subsection{Компоненты системы}

\subsubsection{Веб-сервер}
Веб-сервер разделен на две логические части ---
управление шаблонами, доступная только преподавателям
или администраторам, и генерация программ. Первая отвечает
за добавление и удаление шаблонов программ, вторая --- за создание и получение изображения
и текста программы, а так же за верификацию ответов на задачу.

\subsubsection{Исполнитель программ} \label{executor}
Исполнитель программ отвечает за обработку сгенерированного
кода. Он содержит в себе инструмент форматирования кода, инструмент генерации изображения
кода, а также окружение (компилятор и/или интерпретатор), необходимое для выполнения
программы. С помощью данного компонента осуществляется генерация изображения и получение
вывода программы при ее запуске.

Исполнитель вынесен в отдельный компонент так как ему необходимо специальное окружение
(установленные компиляторы, интерпретаторы, средства форматирования).

\subsubsection{База данных}
\label{db-model}
Для поддержки работы с несколькими пользователями необходимо хранить шаблоны и данные о
сгенерированных программах в базе данных.

В базе сгенерированных программ хранятся параметры генерации,
которые, вместе с
идентификатором задачи, выступают ключом. Также в ней хранятся текст программы,
изображение и вывод программы при запуске.

\label{template-db} В базе шаблонов хранятся шаблоны программ, тег, соответствущий языку или группе
языков, и имя шаблона (задачи), которое является ключом.

\subsubsection{Сторона клиента}
На клиентской стороне пользователь может как взаимодействовать напрямую с сервером,
делая запросы через строку браузера и получая ответ в формате HTML, так и через
специальные образовательные платформы по типу Moodle \cite{moodle}.

\subsubsection{Менеджер шаблонов}
Для создания и управления шаблонами программ на стороне клиента используется отельная
программа --- менеджер шаблонов (Template Manager на схеме). С помощью нее при добавлении текст шаблона
преобразуется в машиночитаемый вид
и затем, вместе с прочей необходимой информацией (названием, тегом) отправляется на сервер
для сохранения в базу шаблонов (см. \ref{template-db}).
